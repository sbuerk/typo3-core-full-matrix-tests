name: "TYPO3 10.4"

on:
  push:

defaults:
  run:
    shell: bash

jobs:
  unit:
    name: "unit"
    runs-on: ubuntu-20.04
    strategy:
      # This prevents cancellation of matrix job runs, if one/two already failed and let the
      # rest matrix jobs be executed anyway.
      fail-fast: false
      matrix:
        coreBranch: [ '10.4' ]
        phpVersion: [ '7.2', '7.3', '7.4' ]
        composerInstallType: ['composerInstallMin', 'composerInstall', 'composerInstallMax']
    steps:
      - name: Checkout github.com/typo3/typo3 on ${{ matrix.coreBranch }}
        uses: actions/checkout@v3
        with:
          repository: typo3/typo3
          ref: ${{ matrix.coreBranch }}
          token: ${{ secrets.GIT_CLONE_TOKEN }}
          path: ./core

      - name: Composer install
        run: Build/Scripts/runTests.sh -p ${{ matrix.phpVersion }} -s ${{ matrix.composerInstallType }}
        working-directory: ./core

      - name: Run tests
        run: Build/Scripts/runTests.sh -p ${{ matrix.phpVersion }} -s unit
        working-directory: ./core

  unitDeprecated:
    name: "unitDeprecated"
    runs-on: ubuntu-20.04
    strategy:
      # This prevents cancellation of matrix job runs, if one/two already failed and let the
      # rest matrix jobs be executed anyway.
      fail-fast: false
      matrix:
        coreBranch: [ '10.4' ]
        phpVersion: [ '7.2', '7.3', '7.4' ]
        composerInstallType: ['composerInstallMin', 'composerInstall', 'composerInstallMax']
    steps:
      - name: Checkout github.com/typo3/typo3 on ${{ matrix.coreBranch }}
        uses: actions/checkout@v3
        with:
          repository: typo3/typo3
          ref: ${{ matrix.coreBranch }}
          token: ${{ secrets.GIT_CLONE_TOKEN }}
          path: ./core

      - name: Composer install
        run: Build/Scripts/runTests.sh -p ${{ matrix.phpVersion }} -s ${{ matrix.composerInstallType }}
        working-directory: ./core

      - name: Run tests
        run: Build/Scripts/runTests.sh -p ${{ matrix.phpVersion }} -s unitDeprecated
        working-directory: ./core
